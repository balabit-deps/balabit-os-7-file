From 46a8443f76cec4b41ec736eca396984c74664f84 Mon Sep 17 00:00:00 2001
From: Christos Zoulas <christos@zoulas.com>
Date: Mon, 26 Aug 2019 14:31:39 +0000
Subject: [PATCH] Limit the number of elements in a vector (found by oss-fuzz)

---
 src/cdf.c | 9 ++++-----
 src/cdf.h | 1 +
 2 files changed, 5 insertions(+), 5 deletions(-)

Index: file-5.32/src/cdf.c
===================================================================
--- file-5.32.orig/src/cdf.c	2019-10-29 12:50:14.608207628 -0400
+++ file-5.32/src/cdf.c	2019-10-29 12:50:14.604207615 -0400
@@ -1000,8 +1000,9 @@ cdf_read_property_info(const cdf_stream_
 				goto out;
 			}
 			nelements = CDF_GETUINT32(q, 1);
-			if (nelements == 0) {
-				DPRINTF(("CDF_VECTOR with nelements == 0\n"));
+			if (nelements > CDF_ELEMENT_LIMIT || nelements == 0) {
+				DPRINTF(("CDF_VECTOR with nelements == %"
+				    SIZE_T_FORMAT "u\n", nelements));
 				goto out;
 			}
 			slen = 2;
@@ -1043,8 +1044,6 @@ cdf_read_property_info(const cdf_stream_
 					goto out;
 				inp += nelem;
 			}
-			DPRINTF(("nelements = %" SIZE_T_FORMAT "u\n",
-			    nelements));
 			for (j = 0; j < nelements && i < sh.sh_properties;
 			    j++, i++)
 			{
Index: file-5.32/src/cdf.h
===================================================================
--- file-5.32.orig/src/cdf.h	2019-10-29 12:50:14.608207628 -0400
+++ file-5.32/src/cdf.h	2019-10-29 12:50:14.608207628 -0400
@@ -48,6 +48,7 @@
 typedef int32_t cdf_secid_t;
 
 #define CDF_LOOP_LIMIT					10000
+#define CDF_ELEMENT_LIMIT				100000
 
 #define CDF_SECID_NULL					0
 #define CDF_SECID_FREE					-1
